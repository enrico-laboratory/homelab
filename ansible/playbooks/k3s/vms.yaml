- name: create vms
  hosts: pvenodes
  become: no
  gather_facts: yes

  tasks:

    - proxmox_kvm:
        api_user: "{{ api_user }}"
        api_token_secret: "{{ lookup('file', 'api_token') }}"
        api_token_id: "{{ api_token_id_k3s }}"
        api_host: "{{ ansible_host }}"
        node: "{{ inventory_hostname }}"
        name: "k3s-{{ item }}"
        clone: "{{ template_name }}"
        newid: "11{{ item }}"
        full: yes
        storage: "{{ storage_name }}"
        cores: 2
        memory: 2048
        format: qcow2
#        searchdomains: 'mydomain.internal'
        update: yes
        nameservers:
          - '8.8.8.8'
        net:
          net0: 'virtio,bridge=vmbr0'
          net1: 'virtio,bridge=vmbr1'
      loop:
        - 1
        - 2
        - 3
        - 4
